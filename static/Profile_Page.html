<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>InfinityChatter</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    header.inbox-header { position:fixed; top:0; left:0; right:0; height:64px; display:flex; align-items:center; justify-content:center; background: rgba(255,255,255,0.9); backdrop-filter: blur(6px); z-index:50; box-shadow:0 1px 6px rgba(0,0,0,0.04); }
    main.inbox-main { padding:1px 16px 5px; max-width:980px; margin:0 auto; }
    .contact-card { display:flex; gap:12px; align-items:center; padding:12px; border-radius:12px; margin-bottom:12px; background:#fff; cursor:pointer; box-shadow:0 6px 18px rgba(2,6,23,0.04); }
    .contact-avatar{ width:56px; height:56px; border-radius:12px; overflow:hidden; display:flex; align-items:center; justify-content:center; background:#eef; font-weight:700; }
    .bottom-nav{ position:fixed; left:50%; transform:translateX(-50%); bottom:16px; width: min(760px, calc(100% - 36px)); background: rgba(255,255,255,0.65); backdrop-filter: blur(8px); border-radius:18px; padding:8px 14px; display:flex; justify-content:space-around; align-items:center; z-index:60; }
    .nav-item{ display:flex; flex-direction:column; align-items:center; font-size:0.9rem; color:#0f172a; cursor:pointer; padding:6px 8px; border-radius:10px; }
  </style>
</head>
<body>
  <header class="inbox-header">
    <div style="width:100%;max-width:980px;text-align:center;">
      <div style="font-weight:800;font-size:18px;">InfinityChatter</div>
      <div style="font-size:0.9rem;color:#64748b;margin-top:2px;"><span id="myNameHeader"></span></div>
    </div>
  </header>

  <main class="inbox-main">
    <div id="contactsContainer">
      <div style="padding:18px;color:#64748b">Loading contacts…</div>
    </div>
  </main>

  <div class="bottom-nav" role="navigation">
    <div class="nav-item" id="nav-chats"><div>Chats</div></div>
    <div class="nav-item" id="nav-calls"><div>Calls</div></div>
    <div class="nav-item" id="nav-profile"><div>Profile</div></div>
    <div class="nav-item" id="nav-settings"><div>Settings</div></div>
  </div>

<script>
(async function(){
  // Requires cs.socket or window.socket for socket.io if you use it
  const socket = window.socket || (window.cs && cs.socket);

  // create Add Contacts box (rounded rectangle)
  function createAddContactsButton() {
    const box = document.createElement('div');
    box.id = 'addContactsBox';
    box.style.cssText = `
      width:calc(100% - 40px);
      max-width:480px;
      margin:18px auto;
      padding:14px 16px;
      border-radius:12px;
      box-shadow:0 4px 20px rgba(15,27,43,0.06);
      background:linear-gradient(180deg, #fff, #fbfdff);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-family:Poppins, sans-serif;
    `;
    box.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px">
        <div style="width:44px;height:44px;border-radius:10px;background:#eef;padding:6px;display:flex;align-items:center;justify-content:center;font-weight:700">+</div>
        <div>
          <div style="font-weight:600">Add Contacts</div>
          <div style="font-size:12px;color:#6b7280">Import from device or share a link</div>
        </div>
      </div>
      <div><button id="openAddContactsBtn" style="padding:8px 12px;border-radius:8px;border:none;background:#0f172a;color:white;cursor:pointer">Open</button></div>
    `;
    return box;
  }

  // insert box at top of main content (adjust selector to your page)
  const container = document.querySelector('#main') || document.body;
  const existing = document.getElementById('addContactsBox');
  if (!existing) {
    const btn = createAddContactsButton();
    container.prepend(btn);
    const openBtn = document.getElementById('openAddContactsBtn');
    if (openBtn) openBtn.addEventListener('click', openAddContactsModal);
  }

  // modal UI builder (no CSV / paste)
  function openAddContactsModal(){
    // overlay
    const overlay = document.createElement('div');
    overlay.id = 'addContactsOverlay';
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:2000;';
    const dialog = document.createElement('div');
    dialog.style.cssText = 'width:92%;max-width:720px;background:white;padding:18px;border-radius:12px;box-shadow:0 10px 40px rgba(2,6,23,0.2);font-family:Poppins, sans-serif;';
    dialog.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <strong style="font-size:18px">Add Contacts</strong>
        <button id="closeAddContacts" style="background:none;border:none;font-size:18px">✖</button>
      </div>
      <div style="display:flex;gap:12px;margin-bottom:10px">
        <button id="useContactPicker" style="flex:1;padding:10px;border-radius:8px;background:#e0e7ff;">Pick from device</button>
        <button id="createInviteLinkBtn" style="flex:1;padding:10px;border-radius:8px;background:#2563eb;color:white;">Create Invite Link</button>
      </div>
      <div id="addContactsResult" style="max-height:320px;overflow:auto"></div>
    `;
    overlay.appendChild(dialog);
    document.body.appendChild(overlay);

    document.getElementById('closeAddContacts')?.addEventListener('click', ()=> overlay.remove());
    document.getElementById('useContactPicker')?.addEventListener('click', pickContactsFromDevice);
    document.getElementById('createInviteLinkBtn')?.addEventListener('click', createInstantShareLink);
  }

  // Contacts Picker (modern browsers, HTTPS, Chrome Android)
  async function pickContactsFromDevice(){
    const resultDiv = document.getElementById('addContactsResult');
    if (!resultDiv) return;
    resultDiv.innerHTML = '<div>Requesting contact permission...</div>';
    try {
      if ('contacts' in navigator && typeof navigator.contacts.select === 'function') {
        const props = ['name','tel'];
        const opts = {multiple:true};
        const contacts = await navigator.contacts.select(props, opts);
        // contacts -> array of objects with {name:[], tel:[]}
        const normalized = [];
        for (const c of contacts) {
          const name = Array.isArray(c.name) ? c.name[0] : (c.name || '');
          const tels = Array.isArray(c.tel) ? c.tel : (c.tel ? [c.tel] : []);
          for (const t of tels) normalized.push({name: name || '', phone: normalizePhone(t)});
        }
        if (!normalized.length) { resultDiv.innerHTML = '<div>No phone numbers selected.</div>'; return; }
        showSelectedAndSend(normalized);
      } else {
        resultDiv.innerHTML = '<div>Your browser does not support the Contacts Picker API. Use the invite link option.</div>';
      }
    } catch (err) {
      console.error(err);
      resultDiv.innerHTML = '<div>Permission denied or error accessing contacts.</div>';
    }
  }

  function normalizePhone(s){
    if(!s) return '';
    // very simple normalization: keep digits and leading +
    return (s + '').replace(/[^0-9+]/g, '');
  }

  // show selected contacts UI and send to server
  function showSelectedAndSend(list){
    const resultDiv = document.getElementById('addContactsResult');
    if (!resultDiv) return;
    const uniq = [];
    const seen = new Set();
    for(const it of list){
      if(!it.phone) continue;
      const p = normalizePhone(it.phone);
      if(!p) continue;
      if(seen.has(p)) continue;
      seen.add(p);
      uniq.push({name: it.name || '', phone: p});
    }
    if(!uniq.length){ resultDiv.innerHTML = '<div>No valid phone numbers found.</div>'; return;}
    resultDiv.innerHTML = '<div style="margin-bottom:8px">Selected contacts:</div>';
    const ul = document.createElement('div');
    ul.style.display = 'grid';
    ul.style.gridTemplateColumns = '1fr 120px';
    ul.style.gap = '8px';
    for(const u of uniq){
      const left = document.createElement('div');
      left.textContent = (u.name || '(no name)') + ' — ' + u.phone;
      const right = document.createElement('div');
      const btn = document.createElement('button');
      btn.textContent = 'Add';
      btn.style.padding = '6px 10px';
      btn.style.borderRadius = '8px';
      btn.addEventListener('click', ()=> sendSelectedToServer([u]));
      right.appendChild(btn);
      ul.appendChild(left); ul.appendChild(right);
    }
    // bulk add button
    const bulk = document.createElement('div');
    bulk.style.gridColumn = '1/-1';
    bulk.innerHTML = `<div style="margin-top:12px"><button id="bulkAddBtn" style="padding:8px 12px;border-radius:10px;background:#0f172a;color:#fff">Add All ${uniq.length}</button></div>`;
    resultDiv.appendChild(ul); resultDiv.appendChild(bulk);
    document.getElementById('bulkAddBtn')?.addEventListener('click', ()=> sendSelectedToServer(uniq));
  }

  // send to server /api/contacts_add
  async function sendSelectedToServer(items){
    const resultDiv = document.getElementById('addContactsResult');
    if (!resultDiv) return;
    resultDiv.innerHTML = '<div>Saving contacts…</div>';
    try {
      const resp = await fetch('/api/contacts_add', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({contacts: items})
      });
      const j = await resp.json().catch(()=>({}));
      if (!resp.ok) {
        resultDiv.innerHTML = `<div style="color:red">Error: ${j.error || resp.status}</div>`;
        return;
      }
      // present: numbers that are on InfinityChatter
      let html = '<div style="margin-bottom:8px"><strong>Result</strong></div>';
      if (j.present && j.present.length){
        html += '<div style="margin-bottom:8px">These contacts are on InfinityChatter:</div>';
        j.present.forEach(p => html += `<div>${p.phone} — ${p.username}</div>`);
      }
      if (j.missing && j.missing.length){
        html += '<div style="margin-top:10px;color:#b91c1c">These numbers are NOT on InfinityChatter:</div>';
        j.missing.forEach(m => {
          html += `<div style="display:flex;gap:8px;align-items:center;margin-top:6px">
                     <div style="flex:1">${m.phone}</div>
                     <button class="shareInviteBtn" data-phone="${m.phone}" style="padding:6px 10px;border-radius:8px">Share invite</button>
                   </div>`;
        });
      }
      resultDiv.innerHTML = html;
      // wire share invite buttons — create link WITHOUT prompting for number (but send phone in body if available)
      Array.from(document.getElementsByClassName('shareInviteBtn')).forEach(b=>{
          b.addEventListener('click', async (ev)=>{
            const phone = b.dataset.phone || null;
            b.textContent = 'Creating…';
        
            // get saved profile name
            const profile = JSON.parse(localStorage.getItem('infinity_profile') || '{}');
            const username = profile.name || profile.username || null;
        
            const body = phone ? { phone } : {};
            if (username) body.username = username;  // include username if available
        
            const r = await fetch('/api/create_contact_invite', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify(body)
            });
        
            const jr = await r.json().catch(()=>({}));
        
            if (jr && jr.url) {
              await navigator.clipboard.writeText(jr.url).catch(()=>{});
              b.textContent = 'Copied link';
              if (navigator.share) {
                try {
                  await navigator.share({title:'Join me on InfinityChatter', text:'Join me on InfinityChatter ♾️', url: jr.url});
                } catch(e){}
              } else {
                alert('Invite link copied to clipboard:\n' + jr.url);
              }
            } else {
              b.textContent = 'Error';
            }
          });
      });
    } catch (err) {
      console.error(err);
      resultDiv.innerHTML = '<div style="color:red">Network or internal error.</div>';
    }
  }

  async function createInstantShareLink(){
      const resDiv = document.getElementById('addContactsResult');
      if (!resDiv) return;
      resDiv.innerHTML = 'Creating invite link...';
    
      // read local profile (if you store it)
      const profile = JSON.parse(localStorage.getItem('infinity_profile')||'{}');
      const username = profile.name || profile.username || null; // best-effort identity
    
      try {
        const res = await fetch('/api/create_contact_invite', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(username ? { username } : {}) // include username if available
        });
        const j = await res.json().catch(()=>({}));
        if (res.ok && j && j.url) {
          // same behavior as earlier
          await navigator.clipboard.writeText(j.url).catch(()=>{});
          resDiv.innerHTML = `
              <div>✅ Invite link created!<br><br>
                <div style="display:flex;gap:8px;align-items:center;">
                  <input id="inviteLinkInput" style="flex:1;padding:6px;border:1px solid #ccc;border-radius:8px" value="${j.url}" readonly />
                  <button id="copyInviteLinkBtn" style="padding:6px 10px;border-radius:8px;background:#0f172a;color:#fff;">Copy</button>
                </div>
              </div>`;
              
          document.getElementById('copyInviteLinkBtn')?.addEventListener('click', async ()=>{
              const link = document.getElementById('inviteLinkInput').value;
              await navigator.clipboard.writeText(link).catch(()=>{});
              alert('Copied link to clipboard!');
          });

        } else {
          resDiv.innerHTML = `<div style="color:red">Failed to create link: ${j.error || res.status}</div>`;
        }
      } catch (err) {
        console.error(err);
        resDiv.innerHTML = '<div style="color:red">Network or internal error.</div>';
      }
  }
})();

(function(){
  // ensure user has local profile
  const profile = JSON.parse(localStorage.getItem('infinity_profile')||'{}');
  if(!profile.name){ window.location.href = '/login'; return; }
  document.getElementById('myNameHeader').textContent = profile.name || '';

  // helper escape
  function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  async function loadContacts(){
    try {
      const resp = await fetch('/contacts_list', { credentials: 'same-origin' });
      if(!resp.ok) throw new Error('failed');
      const data = await resp.json();
      renderContacts(data.contacts || []);
    } catch (err) {
      document.getElementById('contactsContainer').innerHTML = '<div style="padding:18px;color:#c00">Unable to load contacts</div>';
      console.error('loadContacts', err);
    }
  }

  function ensureHeaderAddButton() {
      // check if the button already exists
      if (document.getElementById('headerAddBtn')) return;
    
      // find your header
      const header = document.querySelector('header');
      if (!header) return;
    
      // create the + button
      const btn = document.createElement('button');
      btn.id = 'headerAddBtn';
      btn.textContent = '+';
      btn.title = 'Add Contact';
      btn.style.cssText = `
        position:absolute;
        right:18px;
        top:14px;
        width:38px;
        height:38px;
        border-radius:50%;
        background:#0f172a;
        color:#fff;
        font-size:24px;
        border:none;
        cursor:pointer;
        box-shadow:0 3px 8px rgba(0,0,0,0.1);
        display:flex;
        align-items:center;
        justify-content:center;
      `;
      btn.addEventListener('click', openAddContactsModal); // reuse same modal function
      header.appendChild(btn);
  }

  function renderContacts(list){
      const container = document.getElementById('contactsContainer');
      container.innerHTML = '';
    
      const addBox = document.getElementById('addContactsBox');
    
      if(!list.length){
        // No contacts → show Add Contacts box and remove header button if present
        container.innerHTML = '<div style="padding:18px;color:#64748b">No contacts yet</div>';
        if (addBox) addBox.style.display = 'flex';
        const headerBtn = document.getElementById('headerAddBtn');
        if (headerBtn) headerBtn.remove();
        return;
      }

        // At least one contact → hide big Add box and add header button
        if (addBox) addBox.style.display = 'none';
        ensureHeaderAddButton();

    
      list.forEach(item=>{
        const card = document.createElement('div');
        card.className = 'contact-card';
        card.innerHTML = `
          <div class="contact-avatar">${ item.avatar_url ? '<img src="'+escapeHtml(item.avatar_url)+'" style="width:56px;height:56px;object-fit:cover;border-radius:8px;">' : escapeHtml((item.name||'')[0]||'?') }</div>
          <div style="flex:1">
            <div style="font-weight:700">${escapeHtml(item.name || item.contact)}</div>
            <div style="color:#64748b;font-size:0.9rem;margin-top:6px">${escapeHtml(item.last_text||'')}</div>
          </div>
          <div style="color:#94a3b8;font-size:0.85rem">${item.last_ts?new Date(item.last_ts*1000).toLocaleString():''}</div>`;
        card.addEventListener('click', ()=> window.location.href = '/chat?peer=' + encodeURIComponent(item.contact));
        container.appendChild(card);
      });
  }

  document.getElementById('nav-calls').addEventListener('click', ()=> window.location.href='/calls');
  document.getElementById('nav-profile').addEventListener('click', ()=> window.location.href='/profile');
  document.getElementById('nav-chats').addEventListener('click', ()=> window.location.href='/inbox');
  document.getElementById('nav-settings').addEventListener('click', ()=> window.location.href='/settings');

  loadContacts();
})();
// === InfinityChatter: exact header UI + iOS nav style + corrected nav routing ===
(function() {
  // ---- helpers ----
  function loadFontsOnce() {
    if (!document.querySelector('link[href*="Pacifico"]')) {
      const fonts = document.createElement("link");
      fonts.href = "https://fonts.googleapis.com/css2?family=Pacifico&family=Poppins:wght@400;600&display=swap";
      fonts.rel = "stylesheet";
      document.head.appendChild(fonts);
    }
  }

  function safeInitIcons() {
    try {
      if (window.lucide && typeof window.lucide.createIcons === "function") {
        window.lucide.createIcons();
      } else if (window.lucide?.default?.createIcons) {
        window.lucide.default.createIcons();
      }
    } catch (err) { console.error("Lucide init error:", err); }
  }

  function loadLucideOnce(callback) {
    if (window.lucide || document.querySelector('script[src*="lucide"]')) {
      if (typeof callback === 'function') callback();
      safeInitIcons();
      return;
    }
    const s = document.createElement('script');
    s.src = "https://unpkg.com/lucide@0.395.0/dist/umd/lucide.min.js";
    s.async = true;
    s.onload = () => { safeInitIcons(); if (typeof callback === 'function') callback(); };
    document.head.appendChild(s);
  }

  // ---- UI ----
  loadFontsOnce();
  loadLucideOnce();

  document.querySelectorAll("header").forEach(el => el.remove());
  const header = document.createElement("header");
  header.style.cssText = `
    width:100%;
    background:#fff;
    padding:14px 20px 10px;
    position:fixed;
    top:0;
    left:0;
    z-index:1000;
    box-shadow:0 1px 10px rgba(0,0,0,0.05);
    display:flex;
    flex-direction:column;
    align-items:flex-start;
  `;
  header.innerHTML = `
    <div style="font-family:'Pacifico',cursive;font-size:32px;font-weight:500;color:#0f172a;line-height:1;">InfinityChatter</div>
    <div id="subLabel" style="font-family:'Poppins',sans-serif;font-size:15px;color:#475569;margin-top:3px;">Chats</div>
  `;
  document.body.prepend(header);

  const nav = document.querySelector('.bottom-nav');
  const tabs = [
    { id: "chats", icon: "message-circle", label: "Chats" },
    { id: "calls", icon: "phone", label: "Calls" },
    { id: "profile", icon: "user", label: "Profile" },
    { id: "settings", icon: "settings", label: "Settings" }
  ];

  if (!nav) {
    console.warn("⚠️ .bottom-nav not found");
  } else {
    nav.classList.add("ios-bottom-nav");
    nav.style.cssText = `
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      width:92%;
      max-width:480px;
      background:rgba(255,255,255,0.55);
      backdrop-filter:blur(30px) saturate(180%);
      border:1px solid rgba(255,255,255,0.4);
      border-radius:40px;
      box-shadow:0 10px 25px rgba(0,0,0,0.12);
      display:flex;
      justify-content:space-around;
      align-items:center;
      padding:10px 0;
      font-family:'Poppins',sans-serif;
      z-index:1000;
      transition:all .3s ease;
    `;

    const existing = Array.from(nav.children);
    function makeIconLabel(tab) {
      const frag = document.createDocumentFragment();
      const i = document.createElement('i');
      i.setAttribute('data-lucide', tab.icon);
      i.style.width = '24px';
      i.style.height = '24px';
      i.style.stroke = '#0f172a';
      frag.appendChild(i);
      const lbl = document.createElement('div');
      lbl.style.fontSize = '12px';
      lbl.style.marginTop = '-2px';
      lbl.style.color = '#0f172a';
      lbl.textContent = tab.label;
      frag.appendChild(lbl);
      return frag;
    }

    for (let i = 0; i < tabs.length; i++) {
      const tab = tabs[i];
      let item = existing[i];
      if (item) {
        while (item.firstChild) item.removeChild(item.firstChild);
        item.appendChild(makeIconLabel(tab));
        item.classList.add('nav-item');
        item.dataset.id = tab.id;
        item.style.cssText = "text-align:center;cursor:pointer;transition:transform .2s;flex:1;";
      } else {
        item = document.createElement('div');
        item.className = 'nav-item';
        item.dataset.id = tab.id;
        item.style.cssText = "text-align:center;cursor:pointer;transition:transform .2s;flex:1;";
        item.appendChild(makeIconLabel(tab));
        nav.appendChild(item);
      }
    }

    safeInitIcons();

    // --- fixed and simplified correct navigation map ---
    const routeMap = {
      chats: "/inbox",          // main chat inbox page
      calls: "/calls",    // call page
      profile: "/profile",     // profile page
      settings: "/settings"    // settings page
    };

    Array.from(nav.querySelectorAll('.nav-item')).forEach(item => {
      if (item.getAttribute('data-bound')) return;
      item.setAttribute('data-bound', '1');
      item.addEventListener('click', () => {
        // click animation
        item.style.transform = 'scale(1.12)';
        setTimeout(() => item.style.transform = 'scale(1)', 160);

        const id = item.dataset.id;
        const sub = document.getElementById('subLabel');
        if (sub) sub.textContent = id.charAt(0).toUpperCase() + id.slice(1);

        // correct routing
        const target = routeMap[id];
        if (target && window.location.pathname !== target) {
          window.location.href = target;
        }
      });
    });
  }

  // Elegant non-repeating gradient background
  document.documentElement.style.background = 'linear-gradient(180deg, #f8fafc 0%, #eef2ff 100%)';
  document.documentElement.style.backgroundRepeat = 'no-repeat';
  document.documentElement.style.backgroundAttachment = 'fixed';

  const currTop = parseInt(window.getComputedStyle(document.body).paddingTop || '0', 10);
  if (currTop < 90) document.body.style.paddingTop = '90px';
  const currBottom = parseInt(window.getComputedStyle(document.body).paddingBottom || '0', 10);
  if (currBottom < 130) document.body.style.paddingBottom = '130px';

})();

</script>
</body>
</html>
