<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>InfinityChatter</title>
  <link rel="icon" href="/static/favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/static/favicon.png">
  <link rel="shortcut icon" href="/static/favicon.png">
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="InfinityChatter">
  <meta name="mobile-web-app-capable" content="yes">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    header.inbox-header { position:fixed; top:0; left:0; right:0; height:64px; display:flex; align-items:center; justify-content:center; background: rgba(255,255,255,0.9); backdrop-filter: blur(6px); z-index:50; box-shadow:0 1px 6px rgba(0,0,0,0.04); }
    main.inbox-main { padding:1px 16px 5px; max-width:980px; margin:0 auto; }
    .contact-card { display:flex; gap:12px; align-items:center; padding:12px; border-radius:12px; margin-bottom:12px; background:#fff; cursor:pointer; box-shadow:0 6px 18px rgba(2,6,23,0.04); }
    .contact-avatar{ width:56px; height:56px; border-radius:12px; overflow:hidden; display:flex; align-items:center; justify-content:center; background:#eef; font-weight:700; }
    .bottom-nav{ position:fixed; left:50%; transform:translateX(-50%); bottom:16px; width: min(760px, calc(100% - 36px)); background: rgba(255,255,255,0.65); backdrop-filter: blur(8px); border-radius:18px; padding:8px 14px; display:flex; justify-content:space-around; align-items:center; z-index:60; }
    .nav-item{ display:flex; flex-direction:column; align-items:center; font-size:0.9rem; color:#0f172a; cursor:pointer; padding:6px 8px; border-radius:10px; }
    #pageContent {
      position: relative;
      transition: transform .35s ease;
      will-change: transform;
      overflow-x: hidden;
    }
    body {
      overflow-x: hidden;
    }

  </style>
</head>
<body>
   <header class="inbox-header">
    <div style="width:100%;max-width:980px;text-align:center;position:relative;">
      <div style="font-weight:800;font-size:18px;">InfinityChatter</div>
      <div style="font-size:0.9rem;color:#64748b;margin-top:2px;">
        <span id="myNameHeader"></span>
      </div>
  </header>
  
  <div id="pageContent" style="min-height:60vh;">
    <div id="profileCard" style="
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      background:linear-gradient(135deg,#f8fafc,#eef2ff);
      padding:18px;
      border-radius:18px;
      box-shadow:0 8px 24px rgba(0,0,0,0.06);
      text-align:center;
      margin-bottom:12px;
      max-width:980px;
      margin-left:auto;
      margin-right:auto;
      font-family:'Poppins',sans-serif;
    ">
      <!-- Profile image / initials -->
      <div id="profileAvatar" style="margin-bottom:10px;">
        <img id="profileAvatarImg" src="" style="width:88px;height:88px;border-radius:50%;object-fit:cover;box-shadow:0 6px 18px rgba(0,0,0,0.12);display:none;">
        <div id="profileAvatarFallback" style="width:88px;height:88px;border-radius:50%;background:#e2e8f0;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:30px;color:#0f172a;">?</div>
      </div>
    
      <!-- Name + About -->
      <div id="profileName" style="font-size:1.15rem;font-weight:700;color:#0f172a;">You</div>
      <div id="profileStatus" style="font-size:0.95rem;color:#475569;margin-top:6px;max-width:84%;">Hey there! I'm using InfinityChatter.</div>
    
      <!-- Edit buttons -->
      <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;justify-content:center;">
        <button id="editProfileImageBtn" style="background:#0f172a;color:white;padding:8px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600">
          Edit Profile Image
        </button>
        <button id="editAboutBtn" style="background:#0f172a;color:white;padding:8px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600">
          Edit About
        </button>
      </div>
    </div>
    <main class="inbox-main">
    </main>
  </div>
  
  <div class="bottom-nav" role="navigation" aria-label="main navigation">
    <div class="nav-item" id="nav-chats" data-id="chats" data-path="/inbox"><div>Chats</div></div>
    <div class="nav-item" id="nav-calls" data-id="calls" data-path="/calls"><div>Calls</div></div>
    <div class="nav-item" id="nav-Updates" data-id="Updates" data-path="/updates"><div>Updates</div></div>
    <div class="nav-item" id="nav-settings" data-id="settings" data-path="/settings"><div>Settings</div></div>
  </div>
<script>
// === InfinityChatter: exact header UI + iOS nav style + corrected nav routing ===
(function() {
  // ---- helpers ----
  function loadFontsOnce() {
    if (!document.querySelector('link[href*="Pacifico"]')) {
      const fonts = document.createElement("link");
      fonts.href = "https://fonts.googleapis.com/css2?family=Pacifico&family=Poppins:wght@400;600&display=swap";
      fonts.rel = "stylesheet";
      document.head.appendChild(fonts);
    }
  }

  function safeInitIcons() {
    try {
      if (window.lucide && typeof window.lucide.createIcons === "function") {
        window.lucide.createIcons();
      } else if (window.lucide?.default?.createIcons) {
        window.lucide.default.createIcons();
      }
    } catch (err) { console.error("Lucide init error:", err); }
  }

  function loadLucideOnce(callback) {
    if (window.lucide || document.querySelector('script[src*="lucide"]')) {
      if (typeof callback === 'function') callback();
      safeInitIcons();
      return;
    }
    const s = document.createElement('script');
    s.src = "https://unpkg.com/lucide@0.395.0/dist/umd/lucide.min.js";
    s.async = true;
    s.onload = () => { safeInitIcons(); if (typeof callback === 'function') callback(); };
    document.head.appendChild(s);
  }

  // ---- UI ----
  loadFontsOnce();
  loadLucideOnce();

  document.querySelectorAll("header").forEach(el => el.remove());
  const header = document.createElement("header");
  header.style.cssText = `
    width:100%;
    background:#fff;
    padding:14px 20px 10px;
    position:fixed;
    top:0;
    left:0;
    z-index:1000;
    box-shadow:0 1px 10px rgba(0,0,0,0.05);
    display:flex;
    flex-direction:column;
    align-items:flex-start;
  `;
  header.innerHTML = `
    <div style="font-family:'Pacifico',cursive;font-size:32px;font-weight:500;color:#0f172a;line-height:1;">InfinityChatter</div>
    <div id="subLabel" style="font-family:'Poppins',sans-serif;font-size:15px;color:#475569;margin-top:3px;">Updates</div>
  `;
  document.body.prepend(header);

  const nav = document.querySelector('.bottom-nav');
  const tabs = [
    { id: "chats", icon: "message-circle", label: "Chats" },
    { id: "calls", icon: "phone", label: "Calls" },
    { id: "Updates", icon: "user", label: "Updates" },
    { id: "settings", icon: "settings", label: "Settings" }
  ];

  if (!nav) {
    console.warn("⚠️ .bottom-nav not found");
  } else {
    nav.classList.add("ios-bottom-nav");
    nav.style.cssText = `
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      width:92%;
      max-width:480px;
      background:rgba(255,255,255,0.55);
      backdrop-filter:blur(30px) saturate(180%);
      border:1px solid rgba(255,255,255,0.4);
      border-radius:40px;
      box-shadow:0 10px 25px rgba(0,0,0,0.12);
      display:flex;
      justify-content:space-around;
      align-items:center;
      padding:10px 0;
      font-family:'Poppins',sans-serif;
      z-index:1000;
      transition:all .3s ease;
    `;

    const existing = Array.from(nav.children);
    function makeIconLabel(tab) {
      const frag = document.createDocumentFragment();
      const i = document.createElement('i');
      i.setAttribute('data-lucide', tab.icon);
      i.style.width = '24px';
      i.style.height = '24px';
      i.style.stroke = '#0f172a';
      frag.appendChild(i);
      const lbl = document.createElement('div');
      lbl.style.fontSize = '12px';
      lbl.style.marginTop = '-2px';
      lbl.style.color = '#0f172a';
      lbl.textContent = tab.label;
      frag.appendChild(lbl);
      return frag;
    }

    for (let i = 0; i < tabs.length; i++) {
      const tab = tabs[i];
      let item = existing[i];
      if (item) {
        while (item.firstChild) item.removeChild(item.firstChild);
        item.appendChild(makeIconLabel(tab));
        item.classList.add('nav-item');
        item.dataset.id = tab.id;
        item.style.cssText = "text-align:center;cursor:pointer;transition:transform .2s;flex:1;";
      } else {
        item = document.createElement('div');
        item.className = 'nav-item';
        item.dataset.id = tab.id;
        item.style.cssText = "text-align:center;cursor:pointer;transition:transform .2s;flex:1;";
        item.appendChild(makeIconLabel(tab));
        nav.appendChild(item);
      }
    }

    safeInitIcons();

    // --- fixed and simplified correct navigation map ---
    const routeMap = {
      chats: "/inbox",          // main chat inbox page
      calls: "/calls",    // call page
      Updates: "/updates",     // Updates page
      settings: "/settings"    // settings page
    };
  }

  // Elegant non-repeating gradient background
  document.documentElement.style.background = 'linear-gradient(180deg, #f8fafc 0%, #eef2ff 100%)';
  document.documentElement.style.backgroundRepeat = 'no-repeat';
  document.documentElement.style.backgroundAttachment = 'fixed';

  const currTop = parseInt(window.getComputedStyle(document.body).paddingTop || '0', 10);
  if (currTop < 90) document.body.style.paddingTop = '90px';
  const currBottom = parseInt(window.getComputedStyle(document.body).paddingBottom || '0', 10);
  if (currBottom < 130) document.body.style.paddingBottom = '130px';

})();

(function() {
  const routeMap = {
    chats: '/inbox',
    calls: '/calls',
    Updates: '/Updates',
    settings: '/settings'
  };

  // Inject bounce animation style once
  const style = document.createElement('style');
  style.textContent = `
    @keyframes navBounce {
      0%   { transform: scale(1); }
      30%  { transform: scale(1.25); }
      60%  { transform: scale(0.9); }
      100% { transform: scale(1); }
    }
    .nav-bounce {
      animation: navBounce 0.35s cubic-bezier(.28,1.25,.47,1.03);
    }
  `;
  document.head.appendChild(style);

  // Add click logic with bounce and header update
  document.querySelectorAll('.bottom-nav .nav-item').forEach(item => {
    item.addEventListener('click', e => {
      e.preventDefault();
      item.classList.remove('nav-bounce');
      void item.offsetWidth; // restart animation
      item.classList.add('nav-bounce');

      const id = item.dataset.id;
      const target = routeMap[id];

      // Update header text instantly
      const subLabel = document.getElementById('subLabel');
      if (subLabel) {
        subLabel.textContent = id.charAt(0).toUpperCase() + id.slice(1);
      }

      if (target && window.location.pathname !== target) {
        setTimeout(() => window.location.href = target, 250); // navigate after bounce
      }
    });
  });

  // Set correct header label on first load
  const pathMap = {
    '/inbox': 'Chats',
    '/calls': 'Calls',
    '/Updates': 'Updates',
    '/settings': 'Settings'
  };
  const subLabel = document.getElementById('subLabel');
  if (subLabel) {
    subLabel.textContent = pathMap[window.location.pathname] || 'Chats';
  }
})();

(function(){
  // CONFIG
  const faviconPath = '/static/favicon.png'; // your single file
  const storageKeyInstalled = 'ic_app_installed';
  const storageKeyPromptShown = 'ic_install_prompt_shown';

  // create card UI
  function createInstallBox() {
    // find best insertion point on settings page
    const main = document.querySelector('#settingsMain') || document.querySelector('main') || document.getElementById('pageContent') || document.body;
    if (!main) return;

    // avoid duplicates
    if (document.getElementById('ic-install-box')) return;

    const card = document.createElement('div');
    card.id = 'ic-install-box';
    card.setAttribute('role','button');
    card.setAttribute('aria-label','Install InfinityChatter');
    card.style.cssText = `
      max-width:480px;
      margin:18px auto;
      display:flex;
      align-items:center;
      gap:12px;
      background:linear-gradient(180deg, #ffffff, #fbfdff);
      padding:12px 14px;
      border-radius:12px;
      box-shadow:0 6px 26px rgba(2,6,23,0.06);
      cursor:pointer;
      transition:transform .14s ease, box-shadow .14s ease;
      font-family: Poppins, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    `;
    card.onmousedown = () => { card.style.transform = 'scale(.997)'; };
    card.onmouseup = card.onmouseleave = () => { card.style.transform = 'none'; };

    // favicon corner square
    const imgWrap = document.createElement('div');
    imgWrap.style.cssText = 'width:56px;height:56px;border-radius:12px;overflow:hidden;flex:0 0 56px;display:flex;align-items:center;justify-content:center;background:#f1f5f9;';
    const img = document.createElement('img');
    img.src = faviconPath;
    img.alt = 'InfinityChatter';
    img.style.cssText = 'width:44px;height:44px;object-fit:cover;border-radius:8px;box-shadow:0 2px 8px rgba(2,6,23,0.06)';
    imgWrap.appendChild(img);

    const txt = document.createElement('div');
    txt.style.cssText = 'flex:1;min-width:0';
    txt.innerHTML = `
      <div style="font-weight:700;color:#0f172a;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">Install InfinityChatter</div>
      <div style="font-size:13px;color:#64748b;margin-top:4px">Install to your device for quick access & push-like experience</div>
    `;

    const status = document.createElement('div');
    status.id = 'ic-install-status';
    status.style.cssText = 'margin-left:6px;flex:0 0 auto;font-size:13px;color:#0f172a;font-weight:600;';

    card.appendChild(imgWrap);
    card.appendChild(txt);
    card.appendChild(status);

    // append to page (before first section to make it prominent)
    // if page has a settings container, insert at top
    if (main.firstElementChild) main.insertBefore(card, main.firstElementChild);
    else main.appendChild(card);

    return card;
  }

  // iOS fallback modal (instructions)
  function showIOSInstructions() {
    if (document.getElementById('ic-ios-modal')) return;
    const overlay = document.createElement('div');
    overlay.id = 'ic-ios-modal';
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:99999;';
    overlay.innerHTML = `
      <div style="width:92%;max-width:420px;background:#fff;border-radius:12px;padding:18px;font-family:Poppins, sans-serif;box-shadow:0 12px 40px rgba(2,6,23,0.25);">
        <div style="display:flex;align-items:center;gap:12px;">
          <img src="${faviconPath}" alt="Icon" style="width:56px;height:56px;border-radius:10px;object-fit:cover;">
          <div>
            <div style="font-weight:700;font-size:1.05rem;color:#0f172a">Install InfinityChatter</div>
            <div style="font-size:0.9rem;color:#64748b;margin-top:4px">On iPhone / iPad, use the Share menu → "Add to Home Screen"</div>
          </div>
        </div>
        <ol style="margin-top:12px;color:#475569;padding-left:18px">
          <li>Tap the Share button in Safari (the rectangle + arrow).</li>
          <li>Scroll and tap <strong>Add to Home Screen</strong>.</li>
          <li>Confirm — the app icon will appear on your home screen.</li>
        </ol>
        <div style="text-align:right;margin-top:12px;">
          <button id="ic-ios-close" style="padding:8px 12px;border-radius:8px;background:#0f172a;color:#fff;">Got it</button>
        </div>
      </div>
    `;
    document.body.appendChild(overlay);
    overlay.querySelector('#ic-ios-close').onclick = () => overlay.remove();
  }

  // Toast helper
  function showToast(msg, timeout=1800) {
    const id = 'ic-install-toast';
    if (document.getElementById(id)) return;
    const t = document.createElement('div');
    t.id = id;
    t.style.cssText = 'position:fixed;left:50%;transform:translateX(-50%);bottom:120px;background:#0f172a;color:#fff;padding:8px 12px;border-radius:10px;z-index:100000;font-family:Poppins, sans-serif;';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(()=> t.style.opacity = '0.9', 10);
    setTimeout(()=> t.remove(), timeout);
  }

  // PWA install flow
  let deferredPrompt = null;
  let installBox = null;

  function updateInstallBoxState() {
    if (!installBox) installBox = createInstallBox();
    const statusEl = document.getElementById('ic-install-status');
    const alreadyInstalled = localStorage.getItem(storageKeyInstalled) === '1' || window.matchMedia('(display-mode: standalone)').matches || navigator.standalone === true;
    if (alreadyInstalled) {
      if (statusEl) statusEl.textContent = 'Installed';
      installBox.style.opacity = '0.6';
      installBox.style.pointerEvents = 'none';
      return;
    }
    // show "Install" CTA if prompt is available, else show "Install" anyway (fallback)
    if (statusEl) statusEl.textContent = 'Install';
    installBox.style.pointerEvents = 'auto';
    installBox.onclick = onInstallBoxClick;
  }

  async function onInstallBoxClick(e) {
    // prefer native prompt if available
    if (deferredPrompt) {
      try {
        deferredPrompt.prompt();
        const choice = await deferredPrompt.userChoice;
        deferredPrompt = null;
        localStorage.setItem(storageKeyPromptShown, '1');
        if (choice && choice.outcome === 'accepted') {
          localStorage.setItem(storageKeyInstalled, '1');
          showToast('Installed — enjoy InfinityChatter!');
          updateInstallBoxState();
        } else {
          showToast('Install dismissed');
        }
      } catch (err) {
        console.warn('install prompt failed', err);
        showToast('Install not available');
      }
      return;
    }

    // If not available, detect iOS (Safari) and show instructions
    const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    if (isiOS) {
      showIOSInstructions();
      return;
    }

    // fallback for other browsers: attempt to open manifest or prompt user
    // Some browsers (Chrome Desktop) may show a menu option; we simply show a friendly message
    showToast('If your browser supports PWA install, use the browser menu → Install', 3800);
  }

  // listen for beforeinstallprompt
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault(); // prevent automatic mini-infobar
    deferredPrompt = e;
    localStorage.setItem(storageKeyPromptShown, '1');
    updateInstallBoxState();
  });

  // detect successful install
  window.addEventListener('appinstalled', (e) => {
    localStorage.setItem(storageKeyInstalled, '1');
    showToast('App installed');
    updateInstallBoxState();
  });

  // if user already installed (standalone) mark installed
  if (window.matchMedia('(display-mode: standalone)').matches || navigator.standalone === true) {
    localStorage.setItem(storageKeyInstalled, '1');
  }

  // show UI immediately (box will adapt)
  document.addEventListener('DOMContentLoaded', () => {
    updateInstallBoxState();
  });
  // also run right away if script injected after DOM
  updateInstallBoxState();

  // expose for debugging
  window.__ic_install = {
    showIOSInstructions,
    updateInstallBoxState,
  };
})();

(() => {
  // helper functions
  const loadJSON = (k, f) => { try { return JSON.parse(localStorage.getItem(k)) || f; } catch { return f; } };
  const saveJSON = (k, v) => localStorage.setItem(k, JSON.stringify(v));
  const PROFILE_KEY = "infinity_profile";
  const loadProfile = () => loadJSON(PROFILE_KEY, {});
  const saveProfile = p => saveJSON(PROFILE_KEY, p);

  function renderProfile() {
    const p = loadProfile();
    const avatar = p.avatar_url || "";
    const name = p.name || "You";
    const about = p.status || "Hey there! I'm using InfinityChatter.";

    const img = document.getElementById("profileAvatarImg");
    const fallback = document.getElementById("profileAvatarFallback");
    const nameEl = document.getElementById("profileName");
    const aboutEl = document.getElementById("profileStatus");

    if (avatar) {
      img.src = avatar;
      img.style.display = "block";
      fallback.style.display = "none";
    } else {
      img.style.display = "none";
      fallback.style.display = "flex";
      fallback.textContent = (name[0] || "?").toUpperCase();
    }

    nameEl.textContent = name;
    aboutEl.textContent = about;
  }

  // handle button clicks
  document.body.addEventListener("click", e => {
    const id = e.target.id;
    const profile = loadProfile();

    if (id === "editProfileImageBtn") {
      const inp = document.createElement("input");
      inp.type = "file";
      inp.accept = "image/*";
      inp.onchange = ev => {
        const file = ev.target.files[0];
        if (!file) return;
        const r = new FileReader();
        r.onload = () => {
          profile.avatar_url = r.result;
          saveProfile(profile);
          renderProfile();
        };
        r.readAsDataURL(file);
      };
      inp.click();
    }

    if (id === "editAboutBtn") {
      const val = prompt("Edit About", profile.status || "");
      if (val !== null) {
        profile.status = val.trim();
        saveProfile(profile);
        renderProfile();
      }
    }
  });

  renderProfile();
})();
</script>
</body>
</html>
