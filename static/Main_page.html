<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>InfinityChatter</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    header.inbox-header { position:fixed; top:0; left:0; right:0; height:64px; display:flex; align-items:center; justify-content:center; background: rgba(255,255,255,0.9); backdrop-filter: blur(6px); z-index:50; box-shadow:0 1px 6px rgba(0,0,0,0.04); }
    main.inbox-main { padding:1px 16px 5px; max-width:980px; margin:0 auto; }
    .contact-card { display:flex; gap:12px; align-items:center; padding:12px; border-radius:12px; margin-bottom:12px; background:#fff; cursor:pointer; box-shadow:0 6px 18px rgba(2,6,23,0.04); }
    .contact-avatar{ width:56px; height:56px; border-radius:12px; overflow:hidden; display:flex; align-items:center; justify-content:center; background:#eef; font-weight:700; }
    .bottom-nav{ position:fixed; left:50%; transform:translateX(-50%); bottom:16px; width: min(760px, calc(100% - 36px)); background: rgba(255,255,255,0.65); backdrop-filter: blur(8px); border-radius:18px; padding:8px 14px; display:flex; justify-content:space-around; align-items:center; z-index:60; }
    .nav-item{ display:flex; flex-direction:column; align-items:center; font-size:0.9rem; color:#0f172a; cursor:pointer; padding:6px 8px; border-radius:10px; }
    #pageContent {
      position: relative;
      transition: transform .35s ease;
      will-change: transform;
      overflow-x: hidden;
    }
    body {
      overflow-x: hidden;
    }
  </style>
</head>
<body>
 <header class="inbox-header">
    <div style="width:100%;max-width:980px;text-align:center;position:relative;">
      <div style="font-weight:800;font-size:18px;">InfinityChatter</div>
      <div style="font-size:0.9rem;color:#64748b;margin-top:2px;">
        <span id="myNameHeader"></span>
      </div>
  </header>
  
  <div id="pageContent" style="padding-top:84px; min-height:60vh;">
    <main class="inbox-main">
      <div id="contactsContainer">
        <div style="padding:18px;color:#64748b">Loading contacts…</div>
      </div>
    </main>
  </div>
  
  <div class="bottom-nav" role="navigation" aria-label="main navigation">
    <div class="nav-item" id="nav-chats" data-id="chats" data-path="/inbox"><div>Chats</div></div>
    <div class="nav-item" id="nav-calls" data-id="calls" data-path="/calls"><div>Calls</div></div>
    <div class="nav-item" id="nav-Updates" data-id="Updates" data-path="/updates"><div>Updates</div></div>
    <div class="nav-item" id="nav-settings" data-id="settings" data-path="/settings"><div>Settings</div></div>
  </div>
<script>
(function(){
  // ensure user has local profile
  const profile = JSON.parse(localStorage.getItem('infinity_profile')||'{}');
  if(!profile.name){ window.location.href = '/login'; return; }
  document.getElementById('myNameHeader').textContent = profile.name || '';

  // helper escape
  function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  async function loadContacts(){
    try {
      const resp = await fetch('/contacts_list', { credentials: 'same-origin' });
      if(!resp.ok) throw new Error('failed');
      const data = await resp.json();
      renderContacts(data.contacts || []);
    } catch (err) {
      document.getElementById('contactsContainer').innerHTML = '<div style="padding:18px;color:#c00">Unable to load contacts</div>';
      console.error('loadContacts', err);
    }
  }

  function ensureHeaderAddButton() {
      // check if the button already exists
      if (document.getElementById('headerAddBtn')) return;
    
      // find your header
      const header = document.querySelector('header');
      if (!header) return;
    
      // create the + button
      const btn = document.createElement('button');
      btn.id = 'headerAddBtn';
      btn.textContent = '+';
      btn.title = 'Add Contact';
      btn.style.cssText = `
        position:absolute;
        right:18px;
        top:14px;
        width:38px;
        height:38px;
        border-radius:50%;
        background:#0f172a;
        color:#fff;
        font-size:24px;
        border:none;
        cursor:pointer;
        box-shadow:0 3px 8px rgba(0,0,0,0.1);
        display:flex;
        align-items:center;
        justify-content:center;
      `;
      btn.addEventListener('click', openAddContactsModal); // reuse same modal function
      header.appendChild(btn);
  }

  function renderContacts(list){
      const container = document.getElementById('contactsContainer');
      container.innerHTML = '';
    
      const addBox = document.getElementById('addContactsBox');
    
      if(!list.length){
        // No contacts → show Add Contacts box and remove header button if present
        container.innerHTML = '<div style="padding:18px;color:#64748b">No contacts yet</div>';
        if (addBox) addBox.style.display = 'flex';
        const headerBtn = document.getElementById('headerAddBtn');
        if (headerBtn) headerBtn.remove();
        return;
      }

        // At least one contact → hide big Add box and add header button
        if (addBox) addBox.style.display = 'none';
        ensureHeaderAddButton();

    
      list.forEach(item=>{
        const card = document.createElement('div');
        card.className = 'contact-card';
        card.innerHTML = `
          <div class="contact-avatar">${ item.avatar_url ? '<img src="'+escapeHtml(item.avatar_url)+'" style="width:56px;height:56px;object-fit:cover;border-radius:8px;">' : escapeHtml((item.name||'')[0]||'?') }</div>
          <div style="flex:1">
            <div style="font-weight:700">${escapeHtml(item.name || item.contact)}</div>
            <div style="color:#64748b;font-size:0.9rem;margin-top:6px">${escapeHtml(item.last_text||'')}</div>
          </div>
          <div style="color:#94a3b8;font-size:0.85rem">${item.last_ts?new Date(item.last_ts*1000).toLocaleString():''}</div>`;
        card.addEventListener('click', ()=> window.location.href = '/chat?peer=' + encodeURIComponent(item.contact));
        container.appendChild(card);
      });
  }

  document.getElementById('nav-calls').addEventListener('click', ()=> window.location.href='/calls');
  document.getElementById('nav-Updates').addEventListener('click', ()=> window.location.href='/Updates');
  document.getElementById('nav-chats').addEventListener('click', ()=> window.location.href='/inbox');
  document.getElementById('nav-settings').addEventListener('click', ()=> window.location.href='/settings');

  loadContacts();
})();
// === InfinityChatter: exact header UI + iOS nav style + corrected nav routing ===
(function() {
  // ---- helpers ----
  function loadFontsOnce() {
    if (!document.querySelector('link[href*="Pacifico"]')) {
      const fonts = document.createElement("link");
      fonts.href = "https://fonts.googleapis.com/css2?family=Pacifico&family=Poppins:wght@400;600&display=swap";
      fonts.rel = "stylesheet";
      document.head.appendChild(fonts);
    }
  }

  function safeInitIcons() {
    try {
      if (window.lucide && typeof window.lucide.createIcons === "function") {
        window.lucide.createIcons();
      } else if (window.lucide?.default?.createIcons) {
        window.lucide.default.createIcons();
      }
    } catch (err) { console.error("Lucide init error:", err); }
  }

  function loadLucideOnce(callback) {
    if (window.lucide || document.querySelector('script[src*="lucide"]')) {
      if (typeof callback === 'function') callback();
      safeInitIcons();
      return;
    }
    const s = document.createElement('script');
    s.src = "https://unpkg.com/lucide@0.395.0/dist/umd/lucide.min.js";
    s.async = true;
    s.onload = () => { safeInitIcons(); if (typeof callback === 'function') callback(); };
    document.head.appendChild(s);
  }

  // ---- UI ----
  loadFontsOnce();
  loadLucideOnce();

  document.querySelectorAll("header").forEach(el => el.remove());
  const header = document.createElement("header");
  header.style.cssText = `
    width:100%;
    background:#fff;
    padding:14px 20px 10px;
    position:fixed;
    top:0;
    left:0;
    z-index:1000;
    box-shadow:0 1px 10px rgba(0,0,0,0.05);
    display:flex;
    flex-direction:column;
    align-items:flex-start;
  `;
  header.innerHTML = `
    <div style="font-family:'Pacifico',cursive;font-size:32px;font-weight:500;color:#0f172a;line-height:1;">InfinityChatter</div>
    <div id="subLabel" style="font-family:'Poppins',sans-serif;font-size:15px;color:#475569;margin-top:3px;">Chats</div>
  `;
  document.body.prepend(header);

  const nav = document.querySelector('.bottom-nav');
  const tabs = [
    { id: "chats", icon: "message-circle", label: "Chats" },
    { id: "calls", icon: "phone", label: "Calls" },
    { id: "Updates", icon: "user", label: "Updates" },
    { id: "settings", icon: "settings", label: "Settings" }
  ];

  if (!nav) {
    console.warn("⚠️ .bottom-nav not found");
  } else {
    nav.classList.add("ios-bottom-nav");
    nav.style.cssText = `
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      width:92%;
      max-width:480px;
      background:rgba(255,255,255,0.55);
      backdrop-filter:blur(30px) saturate(180%);
      border:1px solid rgba(255,255,255,0.4);
      border-radius:40px;
      box-shadow:0 10px 25px rgba(0,0,0,0.12);
      display:flex;
      justify-content:space-around;
      align-items:center;
      padding:10px 0;
      font-family:'Poppins',sans-serif;
      z-index:1000;
      transition:all .3s ease;
    `;

    const existing = Array.from(nav.children);
    function makeIconLabel(tab) {
      const frag = document.createDocumentFragment();
      const i = document.createElement('i');
      i.setAttribute('data-lucide', tab.icon);
      i.style.width = '24px';
      i.style.height = '24px';
      i.style.stroke = '#0f172a';
      frag.appendChild(i);
      const lbl = document.createElement('div');
      lbl.style.fontSize = '12px';
      lbl.style.marginTop = '-2px';
      lbl.style.color = '#0f172a';
      lbl.textContent = tab.label;
      frag.appendChild(lbl);
      return frag;
    }

    for (let i = 0; i < tabs.length; i++) {
      const tab = tabs[i];
      let item = existing[i];
      if (item) {
        while (item.firstChild) item.removeChild(item.firstChild);
        item.appendChild(makeIconLabel(tab));
        item.classList.add('nav-item');
        item.dataset.id = tab.id;
        item.style.cssText = "text-align:center;cursor:pointer;transition:transform .2s;flex:1;";
      } else {
        item = document.createElement('div');
        item.className = 'nav-item';
        item.dataset.id = tab.id;
        item.style.cssText = "text-align:center;cursor:pointer;transition:transform .2s;flex:1;";
        item.appendChild(makeIconLabel(tab));
        nav.appendChild(item);
      }
    }

    safeInitIcons();

    // --- fixed and simplified correct navigation map ---
    const routeMap = {
      chats: "/inbox",          // main chat inbox page
      calls: "/calls",    // call page
      Updates: "/Updates",     // Updates page
      settings: "/settings"    // settings page
    };

    Array.from(nav.querySelectorAll('.nav-item')).forEach(item => {
      if (item.getAttribute('data-bound')) return;
      item.setAttribute('data-bound', '1');
      item.addEventListener('click', () => {
        // click animation
        item.style.transform = 'scale(1.12)';
        setTimeout(() => item.style.transform = 'scale(1)', 160);

        const id = item.dataset.id;
        const sub = document.getElementById('subLabel');
        if (sub) sub.textContent = id.charAt(0).toUpperCase() + id.slice(1);

        // correct routing
        const target = routeMap[id];
        if (target && window.location.pathname !== target) {
          window.location.href = target;
        }
      });
    });
  }

  // Elegant non-repeating gradient background
  document.documentElement.style.background = 'linear-gradient(180deg, #f8fafc 0%, #eef2ff 100%)';
  document.documentElement.style.backgroundRepeat = 'no-repeat';
  document.documentElement.style.backgroundAttachment = 'fixed';

  const currTop = parseInt(window.getComputedStyle(document.body).paddingTop || '0', 10);
  if (currTop < 90) document.body.style.paddingTop = '90px';
  const currBottom = parseInt(window.getComputedStyle(document.body).paddingBottom || '0', 10);
  if (currBottom < 130) document.body.style.paddingBottom = '130px';

})();

(function(){
  const routeMap = {
    chats: '/inbox',
    calls: '/calls',
    Updates: '/Updates',
    settings: '/settings'
  };

  const tabOrder = ['chats', 'calls', 'Updates', 'settings'];
  let currentTab = Object.keys(routeMap).find(k => window.location.pathname.includes(k)) || 'chats';

  function slideToPage(targetId){
    if(targetId === currentTab) return;
    const container = document.getElementById('pageContent');
    if(!container) { window.location.href = routeMap[targetId]; return; }

    const targetIndex = tabOrder.indexOf(targetId);
    const currentIndex = tabOrder.indexOf(currentTab);
    const direction = targetIndex > currentIndex ? 'right' : 'left';

    const oldContent = container.cloneNode(true);
    oldContent.style.position = 'absolute';
    oldContent.style.top = '0';
    oldContent.style.left = '0';
    oldContent.style.width = '100%';
    oldContent.style.transition = 'transform .35s ease';
    oldContent.style.zIndex = '1';
    oldContent.style.background = '#fff';

    const newContainer = document.createElement('div');
    newContainer.id = 'pageContent';
    newContainer.style.position = 'absolute';
    newContainer.style.top = '0';
    newContainer.style.width = '100%';
    newContainer.style.transition = 'transform .35s ease';
    newContainer.style.zIndex = '2';
    newContainer.style.background = '#fff';

    // initial position
    newContainer.style.left = direction === 'right' ? '100%' : '-100%';

    document.body.appendChild(newContainer);
    document.body.appendChild(oldContent);

    fetch(routeMap[targetId], {credentials: 'same-origin'})
      .then(r => r.text())
      .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const newInner = doc.getElementById('pageContent');
        if(newInner) newContainer.innerHTML = newInner.innerHTML;
        else newContainer.innerHTML = html;

        requestAnimationFrame(()=>{
          oldContent.style.transform = `translateX(${direction === 'right' ? '-100%' : '100%'})`;
          newContainer.style.transform = `translateX(${direction === 'right' ? '-100%' : '100%'})`;
        });

        setTimeout(()=>{
          oldContent.remove();
          newContainer.style.position = 'relative';
          newContainer.style.left = '0';
          newContainer.style.transform = 'none';
          history.pushState({}, '', routeMap[targetId]);
          currentTab = targetId;
        }, 350);
      })
      .catch(err=>{
        console.error('Slide load failed', err);
        window.location.href = routeMap[targetId];
      });
  }

  // Attach listeners
  document.querySelectorAll('.bottom-nav .nav-item').forEach(item=>{
    item.addEventListener('click', e=>{
      e.preventDefault();
      const id = item.dataset.id;
      slideToPage(id);
    });
  });

  // Handle browser back button
  window.addEventListener('popstate', ()=> window.location.href = location.pathname);
})();

</script>
</body>
</html>
