<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>InfinityChatter</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    header.inbox-header { position:fixed; top:0; left:0; right:0; height:64px; display:flex; align-items:center; justify-content:center; background: rgba(255,255,255,0.9); backdrop-filter: blur(6px); z-index:50; box-shadow:0 1px 6px rgba(0,0,0,0.04); }
    main.inbox-main { padding:1px 16px 5px; max-width:980px; margin:0 auto; }
    .contact-card { display:flex; gap:12px; align-items:center; padding:12px; border-radius:12px; margin-bottom:12px; background:#fff; cursor:pointer; box-shadow:0 6px 18px rgba(2,6,23,0.04); }
    .contact-avatar{ width:56px; height:56px; border-radius:12px; overflow:hidden; display:flex; align-items:center; justify-content:center; background:#eef; font-weight:700; }
    .bottom-nav{ position:fixed; left:50%; transform:translateX(-50%); bottom:16px; width: min(760px, calc(100% - 36px)); background: rgba(255,255,255,0.65); backdrop-filter: blur(8px); border-radius:18px; padding:8px 14px; display:flex; justify-content:space-around; align-items:center; z-index:60; }
    .nav-item{ display:flex; flex-direction:column; align-items:center; font-size:0.9rem; color:#0f172a; cursor:pointer; padding:6px 8px; border-radius:10px; }
    #pageContent {
      position: relative;
      transition: transform .35s ease;
      will-change: transform;
      overflow-x: hidden;
    }
    body {
      overflow-x: hidden;
    }
    .contact-menu-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      border-radius: 50%;
      padding: 8px;
      transition: background 0.2s;
      color: #64748b;
    }
    .contact-menu-btn:hover {
      background: rgba(148, 163, 184, 0.15);
    }
    .contact-popover {
      position: absolute;
      right: 10px;
      top: 58%;
      transform: translateY(-50%) scale(0.9);
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(14px) saturate(180%);
      -webkit-backdrop-filter: blur(14px) saturate(180%);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      box-shadow: 0 12px 35px rgba(0,0,0,0.15);
      min-width: 160px;
      overflow: hidden;
      opacity: 0;
      transition: all 0.25s cubic-bezier(0.19, 1, 0.22, 1);
      z-index: 999;
    }
    .contact-popover.show {
      opacity: 1;
      transform: translateY(-50%) scale(1);
    }
    .contact-popover button {
      display: block;
      width: 100%;
      padding: 10px 14px;
      border: none;
      background: transparent;
      text-align: left;
      color: #0f172a;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .contact-popover button:hover {
      background: rgba(255, 255, 255, 0.35);
    }
    .contact-popover .danger {
      color: #dc2626;
    }
    /* page view container + sliding animations */
    #mainContent { position: relative; overflow: hidden; }
    
    /* child views we inject */
    .page-view {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      will-change: transform, opacity;
      transition: transform 320ms cubic-bezier(.2,.9,.3,1), opacity 220ms ease;
      transform: translateX(0);
      opacity: 1;
    }
    
    /* Enter/Exit positions */
    .page-enter-from-right  { transform: translateX(18%); opacity: 0; }
    .page-enter-from-left   { transform: translateX(-18%); opacity: 0; }
    .page-enter-to-center   { transform: translateX(0); opacity: 1; }
    
    .page-exit-to-left      { transform: translateX(-18%); opacity: 0; }
    .page-exit-to-right     { transform: translateX(18%); opacity: 0; }
    
    /* small shadow to emphasize layering */
    .page-view .page-inner {
      background: transparent; /* keep your page background */
      height: 100%;
      box-shadow: 0 8px 24px rgba(2,6,23,0.06);
    }
    
    /* optional: subtle fade on old content while animating */
    .page-view.exiting { pointer-events: none; }
  </style>
</head>
<body>
 <header class="inbox-header">
    <div style="width:100%;max-width:980px;text-align:center;position:relative;">
      <div style="font-weight:800;font-size:18px;">InfinityChatter</div>
      <div style="font-size:0.9rem;color:#64748b;margin-top:2px;">
        <span id="myNameHeader"></span>
      </div>
  </header>
  
  <div id="pageContent" style="min-height:60vh;">
    <main class="inbox-main">
      <div id="contactsContainer">
        <div style="padding:18px;color:#64748b">Loading contacts…</div>
      </div>
    </main>
  </div>
  
  <div class="bottom-nav" role="navigation" aria-label="main navigation">
    <div class="nav-item" id="nav-chats" data-id="chats" data-path="/inbox"><div>Chats</div></div>
    <div class="nav-item" id="nav-calls" data-id="calls" data-path="/calls"><div>Calls</div></div>
    <div class="nav-item" id="nav-Updates" data-id="Updates" data-path="/updates"><div>Updates</div></div>
    <div class="nav-item" id="nav-settings" data-id="settings" data-path="/settings"><div>Settings</div></div>
  </div>
<script>
(async function(){
  // Requires cs.socket or window.socket for socket.io if you use it
  const socket = window.socket || (window.cs && cs.socket);

  // create Add Contacts box (rounded rectangle)
  function createAddContactsButton() {
    const box = document.createElement('div');
    box.id = 'addContactsBox';
    box.style.cssText = `
      width:calc(100% - 40px);
      max-width:480px;
      margin:18px auto;
      padding:14px 16px;
      border-radius:12px;
      box-shadow:0 4px 20px rgba(15,27,43,0.06);
      background:linear-gradient(180deg, #fff, #fbfdff);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-family:Poppins, sans-serif;
    `;
    box.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px">
        <div style="width:44px;height:44px;border-radius:10px;background:#eef;padding:6px;display:flex;align-items:center;justify-content:center;font-weight:700">+</div>
        <div>
          <div style="font-weight:600">Add Contacts</div>
          <div style="font-size:12px;color:#6b7280">Import from device or share a link</div>
        </div>
      </div>
      <div><button id="openAddContactsBtn" style="padding:8px 12px;border-radius:8px;border:none;background:#0f172a;color:white;cursor:pointer">Open</button></div>
    `;
    return box;
  }

  // insert box at top of main content (adjust selector to your page)
  const container = document.querySelector('#main') || document.body;
  const existing = document.getElementById('addContactsBox');
  if (!existing) {
    const btn = createAddContactsButton();
    container.prepend(btn);
    const openBtn = document.getElementById('openAddContactsBtn');
    if (openBtn) openBtn.addEventListener('click', openAddContactsModal);
  }

  // modal UI builder (no CSV / paste)
  function openAddContactsModal(){
    // overlay
    const overlay = document.createElement('div');
    overlay.id = 'addContactsOverlay';
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:2000;';
    const dialog = document.createElement('div');
    dialog.style.cssText = 'width:92%;max-width:720px;background:white;padding:18px;border-radius:12px;box-shadow:0 10px 40px rgba(2,6,23,0.2);font-family:Poppins, sans-serif;';
    dialog.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <strong style="font-size:18px">Add Contacts</strong>
        <button id="closeAddContacts" style="background:none;border:none;font-size:18px">✖</button>
      </div>
      <div style="display:flex;gap:12px;margin-bottom:10px">
        <button id="useContactPicker" style="flex:1;padding:10px;border-radius:8px;background:#e0e7ff;">Pick from device</button>
        <button id="createInviteLinkBtn" style="flex:1;padding:10px;border-radius:8px;background:#2563eb;color:white;">Create Invite Link</button>
      </div>
      <div id="addContactsResult" style="max-height:320px;overflow:auto"></div>
    `;
    overlay.appendChild(dialog);
    document.body.appendChild(overlay);

    document.getElementById('closeAddContacts')?.addEventListener('click', ()=> overlay.remove());
    document.getElementById('useContactPicker')?.addEventListener('click', pickContactsFromDevice);
    document.getElementById('createInviteLinkBtn')?.addEventListener('click', createInstantShareLink);
  }

  // Contacts Picker (modern browsers, HTTPS, Chrome Android)
  async function pickContactsFromDevice(){
    const resultDiv = document.getElementById('addContactsResult');
    if (!resultDiv) return;
    resultDiv.innerHTML = '<div>Requesting contact permission...</div>';
    try {
      if ('contacts' in navigator && typeof navigator.contacts.select === 'function') {
        const props = ['name','tel'];
        const opts = {multiple:true};
        const contacts = await navigator.contacts.select(props, opts);
        // contacts -> array of objects with {name:[], tel:[]}
        const normalized = [];
        for (const c of contacts) {
          const name = Array.isArray(c.name) ? c.name[0] : (c.name || '');
          const tels = Array.isArray(c.tel) ? c.tel : (c.tel ? [c.tel] : []);
          for (const t of tels) normalized.push({name: name || '', phone: normalizePhone(t)});
        }
        if (!normalized.length) { resultDiv.innerHTML = '<div>No phone numbers selected.</div>'; return; }
        showSelectedAndSend(normalized);
      } else {
        resultDiv.innerHTML = '<div>Your browser does not support the Contacts Picker API. Use the invite link option.</div>';
      }
    } catch (err) {
      console.error(err);
      resultDiv.innerHTML = '<div>Permission denied or error accessing contacts.</div>';
    }
  }

  function normalizePhone(s){
    if(!s) return '';
    // very simple normalization: keep digits and leading +
    return (s + '').replace(/[^0-9+]/g, '');
  }

  // show selected contacts UI and send to server
  function showSelectedAndSend(list){
    const resultDiv = document.getElementById('addContactsResult');
    if (!resultDiv) return;
    const uniq = [];
    const seen = new Set();
    for(const it of list){
      if(!it.phone) continue;
      const p = normalizePhone(it.phone);
      if(!p) continue;
      if(seen.has(p)) continue;
      seen.add(p);
      uniq.push({name: it.name || '', phone: p});
    }
    if(!uniq.length){ resultDiv.innerHTML = '<div>No valid phone numbers found.</div>'; return;}
    resultDiv.innerHTML = '<div style="margin-bottom:8px">Selected contacts:</div>';
    const ul = document.createElement('div');
    ul.style.display = 'grid';
    ul.style.gridTemplateColumns = '1fr 120px';
    ul.style.gap = '8px';
    for(const u of uniq){
      const left = document.createElement('div');
      left.textContent = (u.name || '(no name)') + ' — ' + u.phone;
      const right = document.createElement('div');
      const btn = document.createElement('button');
      btn.textContent = 'Add';
      btn.style.padding = '6px 10px';
      btn.style.borderRadius = '8px';
      btn.addEventListener('click', ()=> sendSelectedToServer([u]));
      right.appendChild(btn);
      ul.appendChild(left); ul.appendChild(right);
    }
    // bulk add button
    const bulk = document.createElement('div');
    bulk.style.gridColumn = '1/-1';
    bulk.innerHTML = `<div style="margin-top:12px"><button id="bulkAddBtn" style="padding:8px 12px;border-radius:10px;background:#0f172a;color:#fff">Add All ${uniq.length}</button></div>`;
    resultDiv.appendChild(ul); resultDiv.appendChild(bulk);
    document.getElementById('bulkAddBtn')?.addEventListener('click', ()=> sendSelectedToServer(uniq));
  }

  // send to server /api/contacts_add
  async function sendSelectedToServer(items){
    const resultDiv = document.getElementById('addContactsResult');
    if (!resultDiv) return;
    resultDiv.innerHTML = '<div>Saving contacts…</div>';
    try {
      const resp = await fetch('/api/contacts_add', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({contacts: items})
      });
      const j = await resp.json().catch(()=>({}));
      if (!resp.ok) {
        resultDiv.innerHTML = `<div style="color:red">Error: ${j.error || resp.status}</div>`;
        return;
      }
      // present: numbers that are on InfinityChatter
      let html = '<div style="margin-bottom:8px"><strong>Result</strong></div>';
      if (j.present && j.present.length){
        html += '<div style="margin-bottom:8px">These contacts are on InfinityChatter:</div>';
        j.present.forEach(p => html += `<div>${p.phone} — ${p.username}</div>`);
      }
      if (j.missing && j.missing.length){
        html += '<div style="margin-top:10px;color:#b91c1c">These numbers are NOT on InfinityChatter:</div>';
        j.missing.forEach(m => {
          html += `<div style="display:flex;gap:8px;align-items:center;margin-top:6px">
                     <div style="flex:1">${m.phone}</div>
                     <button class="shareInviteBtn" data-phone="${m.phone}" style="padding:6px 10px;border-radius:8px">Share invite</button>
                   </div>`;
        });
      }
      resultDiv.innerHTML = html;
      // wire share invite buttons — create link WITHOUT prompting for number (but send phone in body if available)
      Array.from(document.getElementsByClassName('shareInviteBtn')).forEach(b=>{
          b.addEventListener('click', async (ev)=>{
            const phone = b.dataset.phone || null;
            b.textContent = 'Creating…';
        
            // get saved profile name
            const profile = JSON.parse(localStorage.getItem('infinity_profile') || '{}');
            const username = profile.name || profile.username || null;
        
            const body = phone ? { phone } : {};
            if (username) body.username = username;  // include username if available
        
            const r = await fetch('/api/create_contact_invite', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify(body)
            });
        
            const jr = await r.json().catch(()=>({}));
        
            if (jr && jr.url) {
              await navigator.clipboard.writeText(jr.url).catch(()=>{});
              b.textContent = 'Copied link';
              if (navigator.share) {
                try {
                  await navigator.share({title:'Join me on InfinityChatter', text:'Join me on InfinityChatter ♾️', url: jr.url});
                } catch(e){}
              } else {
                alert('Invite link copied to clipboard:\n' + jr.url);
              }
            } else {
              b.textContent = 'Error';
            }
          });
      });
    } catch (err) {
      console.error(err);
      resultDiv.innerHTML = '<div style="color:red">Network or internal error.</div>';
    }
  }

  async function createInstantShareLink(){
      const resDiv = document.getElementById('addContactsResult');
      if (!resDiv) return;
      resDiv.innerHTML = 'Creating invite link...';
    
      // read local profile (if you store it)
      const profile = JSON.parse(localStorage.getItem('infinity_profile')||'{}');
      const username = profile.name || profile.username || null; // best-effort identity
    
      try {
        const res = await fetch('/api/create_contact_invite', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(username ? { username } : {}) // include username if available
        });
        const j = await res.json().catch(()=>({}));
        if (res.ok && j && j.url) {
          // same behavior as earlier
          await navigator.clipboard.writeText(j.url).catch(()=>{});
          resDiv.innerHTML = `
              <div>✅ Invite link created!<br><br>
                <div style="display:flex;gap:8px;align-items:center;">
                  <input id="inviteLinkInput" style="flex:1;padding:6px;border:1px solid #ccc;border-radius:8px" value="${j.url}" readonly />
                  <button id="copyInviteLinkBtn" style="padding:6px 10px;border-radius:8px;background:#0f172a;color:#fff;">Copy</button>
                </div>
              </div>`;
              
          document.getElementById('copyInviteLinkBtn')?.addEventListener('click', async ()=>{
              const link = document.getElementById('inviteLinkInput').value;
              await navigator.clipboard.writeText(link).catch(()=>{});
              alert('Copied link to clipboard!');
          });

        } else {
          resDiv.innerHTML = `<div style="color:red">Failed to create link: ${j.error || res.status}</div>`;
        }
      } catch (err) {
        console.error(err);
        resDiv.innerHTML = '<div style="color:red">Network or internal error.</div>';
      }
  }
  window.openAddContactsModal = openAddContactsModal;
})();

(function(){
  // --- basic checks & profile ---
  const profile = JSON.parse(localStorage.getItem('infinity_profile') || '{}');
  if (!profile.name) { window.location.href = '/login'; return; }
  const myNameEl = document.getElementById('myNameHeader');
  if (myNameEl) myNameEl.textContent = profile.name || '';

  // --- socket: init & register (if available) ---
  (function initSocketRegistration(){
    try {
      const profileLocal = JSON.parse(localStorage.getItem('infinity_profile') || '{}');
      const username = (profileLocal.name || profileLocal.username || '').trim();
      if (!window.socket && typeof window.io === 'function') {
        try { window.socket = io(); } catch (e) { console.warn('socket.io init failed', e); }
      }
      const socket = window.socket || (window.cs && cs.socket);
      if (!socket || !username) return;

      if (socket.connected) socket.emit('register_socket', { username });
      else socket.on('connect', () => socket.emit('register_socket', { username }));

      socket.on('contact_added_by_invite', data => {
        console.log('New contact added via invite:', data);
        try { loadContacts(); } catch (e) { console.warn('loadContacts reload failed', e); }
        if (typeof showToast === 'function') showToast(`New contact: ${data.new_name}`);
        else {
          const el = document.createElement('div');
          el.textContent = `New contact: ${data.new_name}`;
          el.style.cssText = 'position:fixed;bottom:120px;left:50%;transform:translateX(-50%);background:#111;color:#fff;padding:8px 12px;border-radius:8px;z-index:3000';
          document.body.appendChild(el);
          setTimeout(()=> el.remove(), 3500);
        }
      });
    } catch (err) {
      console.warn('socket init err', err);
    }
  })();

  // --- helpers ---
  function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // header add button helpers
  function ensureHeaderAddButton() {
    if (document.getElementById('headerAddBtn')) return;
    const header = document.querySelector('header');
    if (!header) return;
    const btn = document.createElement('button');
    btn.id = 'headerAddBtn';
    btn.title = 'Add Contact';
    btn.textContent = '+';
    btn.style.cssText = `
      position:absolute; right:18px; top:14px; width:38px; height:38px;
      border-radius:50%; background:#0f172a; color:#fff; font-size:24px; border:none;
      cursor:pointer; box-shadow:0 3px 8px rgba(0,0,0,0.1); display:flex;align-items:center;justify-content:center;
    `;
    btn.addEventListener('click', () => { if (typeof openAddContactsModal === 'function') openAddContactsModal(); });
    header.appendChild(btn);
  }
  function removeHeaderAddButton(){
    const b = document.getElementById('headerAddBtn');
    if (b) b.remove();
  }

  // --- popover CSS (single injection) ---
  if (!document.getElementById('contact-popover-style')) {
    const s = document.createElement('style');
    s.id = 'contact-popover-style';
    s.textContent = `
      .contact-popover {
        position: absolute;
        min-width:160px;
        padding:8px;
        border-radius:12px;
        box-shadow: 0 8px 30px rgba(2,6,23,0.12);
        backdrop-filter: blur(8px) saturate(120%);
        background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(250,250,250,0.9));
        color: #0f172a;
        z-index: 4000;
        transform-origin: top right;
        opacity: 0;
        transform: translateY(-6px) scale(.98);
        transition: opacity .18s ease, transform .18s cubic-bezier(.2,.9,.3,1);
        overflow: hidden;
      }
      .contact-popover.show { opacity:1; transform: translateY(0) scale(1); }
      .contact-popover button { display:block; width:100%; text-align:left; padding:8px 10px; border:none; background:transparent; font-size:0.95rem; cursor:pointer; border-radius:8px; }
      .contact-popover button:hover { background: rgba(15,23,42,0.04); }
      .contact-popover .danger { color:#b91c1c; }
    `;
    document.head.appendChild(s);
  }

  // closes any popovers attached to body
  function closeAllContactMenus() {
    document.querySelectorAll('.contact-popover').forEach(p => p.remove());
    document.querySelectorAll('.contact-menu-btn').forEach(b => b.setAttribute('aria-expanded','false'));
  }

  // create popover in body and position it to avoid clipping
  function toggleContactMenu(triggerBtn, card, item) {
    // close existing for same contact
    const existing = document.querySelector('.contact-popover[data-for="' + (item.contact||'') + '"]');
    if (existing) { existing.classList.remove('show'); setTimeout(()=> existing.remove(), 160); return; }

    closeAllContactMenus();

    const menu = document.createElement('div');
    menu.className = 'contact-popover';
    menu.setAttribute('data-for', item.contact || '');
    menu.innerHTML = `
      <button data-action="open">Open Chat</button>
      <button data-action="block">Block</button>
      <button data-action="delete" class="danger">Delete Chat</button>
    `;
    document.body.appendChild(menu);

    // position it using trigger bounding rect (keep within viewport)
    const rect = triggerBtn.getBoundingClientRect();
    const menuW = Math.min(menu.offsetWidth || 200, window.innerWidth - 16);
    let left = rect.right - menuW + 8;
    left = Math.max(8, Math.min(left, window.innerWidth - menuW - 8));
    const top = rect.bottom + window.scrollY + 8;
    menu.style.left = left + 'px';
    menu.style.top = top + 'px';

    requestAnimationFrame(()=> menu.classList.add('show'));
    try { triggerBtn.setAttribute('aria-expanded','true'); } catch(e){}

    // actions
    menu.querySelector('[data-action="open"]').addEventListener('click', (e) => {
      e.stopPropagation();
      const qs = new URLSearchParams();
      qs.set('t', item.contact === 'self' ? 'self' : (item.peer_token || item.contact));
      if (profile && profile.name) qs.set('username', profile.name);
      window.location.href = '/chat?' + qs.toString();
      closeAllContactMenus();
    });

    menu.querySelector('[data-action="block"]').addEventListener('click', (e) => {
      e.stopPropagation();
      if (confirm(`Block ${item.name || item.contact}?`)) {
        card.style.opacity = '0.5';
        // TODO: call API to block
      }
      closeAllContactMenus();
    });

    menu.querySelector('[data-action="delete"]').addEventListener('click', (e) => {
      e.stopPropagation();
      if (confirm(`Delete chat with ${item.name || item.contact}?`)) {
        card.remove();
        // TODO: notify server
      }
      closeAllContactMenus();
    });

    // outside click closes (one-time listener)
    const onDoc = (ev) => {
      if (!menu.contains(ev.target) && !triggerBtn.contains(ev.target)) {
        menu.classList.remove('show');
        setTimeout(()=> menu.remove(), 160);
        document.removeEventListener('click', onDoc);
      }
    };
    setTimeout(()=> document.addEventListener('click', onDoc), 10);
  }

  // --- load contacts from server and render ---
  async function loadContacts(){
    const container = document.getElementById('contactsContainer');
    if (!container) return;
    try {
      const profileLocal = JSON.parse(localStorage.getItem('infinity_profile') || '{}');
      const username = (profileLocal.name || profileLocal.username || '').trim();
      const url = username ? `/contacts_list?username=${encodeURIComponent(username)}` : '/contacts_list';
      const resp = await fetch(url, { credentials: 'same-origin' });
      if (!resp.ok) throw new Error('failed: ' + resp.status);
      const data = await resp.json();
      renderContacts(data.contacts || []);
    } catch (err) {
      if (container) container.innerHTML = '<div style="padding:18px;color:#c00">Unable to load contacts</div>';
      console.error('loadContacts', err);
    }
  }

  // --- renderContacts (stable self chat, add-button visibility, menu) ---
  function renderContacts(list) {
    const container = document.getElementById('contactsContainer');
    if (!container) return;
    container.innerHTML = '';

    const addBox = document.getElementById('addContactsBox');

    // profile already read above
    const userLabel = profile.name || profile.username || 'You';
    const selfContact = {
      name: `${userLabel} (You)`,
      contact: 'self',
      last_text: 'Message Yourself',
      last_ts: Math.floor(Date.now() / 1000),
      avatar_url: profile.avatar_url || ''
    };

    list = Array.isArray(list) ? [...list] : [];

    // ensure self exists (only once)
    if (!list.some(c => (c.contact||'').toString().toLowerCase() === 'self')) list.push(selfContact);

    // sort by timestamp desc
    list.sort((a,b) => (b.last_ts || 0) - (a.last_ts || 0));

    // toggle add UI: show big addBox only when there is only self
    if (list.length <= 1) {
      if (addBox) addBox.style.display = 'flex';
      removeHeaderAddButton();
    } else {
      if (addBox) addBox.style.display = 'none';
      ensureHeaderAddButton();
    }

    // render cards
    list.forEach(item => {
      const card = document.createElement('div');
      card.className = 'contact-card';
      card.style.position = 'relative';
      card.style.display = 'flex';
      card.style.alignItems = 'center';
      card.style.gap = '12px';
      card.style.padding = '10px';
      card.dataset.contact = item.contact || '';

      const avatarHtml = item.avatar_url
        ? `<img src="${escapeHtml(item.avatar_url)}" style="width:56px;height:56px;object-fit:cover;border-radius:8px;">`
        : `<div style="width:56px;height:56px;display:flex;align-items:center;justify-content:center;background:#e6eef7;border-radius:8px;font-weight:700;color:#0f172a">${escapeHtml((item.name||'?')[0]||'?')}</div>`;

      card.innerHTML = `
        <div class="contact-avatar">${avatarHtml}</div>
        <div style="flex:1;min-width:0">
          <div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
            ${escapeHtml(item.name || item.contact)}
          </div>
          <div style="color:#64748b;font-size:0.9rem;margin-top:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
            ${escapeHtml(item.last_text || '')}
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <div style="color:#94a3b8;font-size:0.85rem;white-space:nowrap">${item.last_ts ? new Date(item.last_ts*1000).toLocaleString() : ''}</div>
          <button class="contact-menu-btn" title="Options" aria-haspopup="true" aria-expanded="false" style="background:none;border:none;padding:6px;cursor:pointer">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="19" r="1"></circle>
            </svg>
          </button>
        </div>
      `;

      card.addEventListener('click', (e) => {
        // stop any other handlers / default behavior
        e.preventDefault?.();
        e.stopPropagation?.();
        if (typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();
      
        // ignore clicks on the menu button
        if (e.target.closest && e.target.closest('.contact-menu-btn')) return;
      
        // compute peer / self
        const profileLocal = JSON.parse(localStorage.getItem('infinity_profile') || '{}');
        const peerRaw = item.peer_token || item.contact || null;
        const profileId = (profileLocal.username || profileLocal.name || '').toString();
        const isSelf = (peerRaw === 'self') || (profileId && peerRaw === profileId);
      
        const t = isSelf ? 'self' : (peerRaw || null);
        if (!t) {
          console.warn('renderContacts: no peer token for contact', item);
          // optional fallback: open empty chat page or show toast instead of redirect
          return;
        }
      
        const qs = new URLSearchParams();
        qs.set('t', t);
        if (profileLocal && profileLocal.name) qs.set('username', profileLocal.name);
      
        // use assign to navigate (clean)
        window.location.assign('/chat?' + qs.toString());
      });

      // menu handling
      const menuBtn = card.querySelector('.contact-menu-btn');
      if (menuBtn) {
        menuBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleContactMenu(menuBtn, card, item);
        });
      }

      container.appendChild(card);
    });
  }

  // expose renderContacts for debug/console
  window.renderContacts = renderContacts;
  window.__infinity = window.__infinity || {};
  window.__infinity.closeContactMenus = closeAllContactMenus;

  // --- nav bindings (simple direct navigation) ---
  function bindNav(){
    // remove existing handlers by cloning nodes (defensive)
    ['nav-calls','nav-Updates','nav-chats','nav-settings'].forEach(id=>{
      const el = document.getElementById(id);
      if (el) {
        const clone = el.cloneNode(true);
        el.parentNode.replaceChild(clone, el);
      }
    });

    const map = {
      'nav-calls': '/calls',
      'nav-Updates': '/Updates',
      'nav-chats': '/inbox',
      'nav-settings': '/settings'
    };
    Object.keys(map).forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('click', ()=> { window.location.href = map[id]; });
    });

    // also attach generic bottom-nav .nav-item listeners (if present)
    document.querySelectorAll('.bottom-nav .nav-item').forEach(item=>{
      item.addEventListener('click', (e)=>{
        e.preventDefault();
        const id = (item.dataset.id || '').toString();
        const route = {
          chats: '/inbox', calls: '/calls', Updates: '/Updates', settings: '/settings'
        }[id] || '/inbox';
        window.location.href = route;
      });
    });
  }
  bindNav();

  // initial load
  loadContacts();

})();

// === InfinityChatter: exact header UI + iOS nav style + corrected nav routing ===
(function() {
  // ---- helpers ----
  function loadFontsOnce() {
    if (!document.querySelector('link[href*="Pacifico"]')) {
      const fonts = document.createElement("link");
      fonts.href = "https://fonts.googleapis.com/css2?family=Pacifico&family=Poppins:wght@400;600&display=swap";
      fonts.rel = "stylesheet";
      document.head.appendChild(fonts);
    }
  }

  function safeInitIcons() {
    try {
      if (window.lucide && typeof window.lucide.createIcons === "function") {
        window.lucide.createIcons();
      } else if (window.lucide?.default?.createIcons) {
        window.lucide.default.createIcons();
      }
    } catch (err) { console.error("Lucide init error:", err); }
  }

  function loadLucideOnce(callback) {
    if (window.lucide || document.querySelector('script[src*="lucide"]')) {
      if (typeof callback === 'function') callback();
      safeInitIcons();
      return;
    }
    const s = document.createElement('script');
    s.src = "https://unpkg.com/lucide@0.395.0/dist/umd/lucide.min.js";
    s.async = true;
    s.onload = () => { safeInitIcons(); if (typeof callback === 'function') callback(); };
    document.head.appendChild(s);
  }

  // ---- UI ----
  loadFontsOnce();
  loadLucideOnce();

  document.querySelectorAll("header").forEach(el => el.remove());
  const header = document.createElement("header");
  header.style.cssText = `
    width:100%;
    background:#fff;
    padding:14px 20px 10px;
    position:fixed;
    top:0;
    left:0;
    z-index:1000;
    box-shadow:0 1px 10px rgba(0,0,0,0.05);
    display:flex;
    flex-direction:column;
    align-items:flex-start;
  `;
  header.innerHTML = `
    <div style="font-family:'Pacifico',cursive;font-size:32px;font-weight:500;color:#0f172a;line-height:1;">InfinityChatter</div>
    <div id="subLabel" style="font-family:'Poppins',sans-serif;font-size:15px;color:#475569;margin-top:3px;">Chats</div>
  `;
  document.body.prepend(header);

  const nav = document.querySelector('.bottom-nav');
  const tabs = [
    { id: "chats", icon: "message-circle", label: "Chats" },
    { id: "calls", icon: "phone", label: "Calls" },
    { id: "Updates", icon: "user", label: "Updates" },
    { id: "settings", icon: "settings", label: "Settings" }
  ];

  if (!nav) {
    console.warn("⚠️ .bottom-nav not found");
  } else {
    nav.classList.add("ios-bottom-nav");
    nav.style.cssText = `
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      width:92%;
      max-width:480px;
      background:rgba(255,255,255,0.55);
      backdrop-filter:blur(30px) saturate(180%);
      border:1px solid rgba(255,255,255,0.4);
      border-radius:40px;
      box-shadow:0 10px 25px rgba(0,0,0,0.12);
      display:flex;
      justify-content:space-around;
      align-items:center;
      padding:10px 0;
      font-family:'Poppins',sans-serif;
      z-index:1000;
      transition:all .3s ease;
    `;

    const existing = Array.from(nav.children);
    function makeIconLabel(tab) {
      const frag = document.createDocumentFragment();
      const i = document.createElement('i');
      i.setAttribute('data-lucide', tab.icon);
      i.style.width = '24px';
      i.style.height = '24px';
      i.style.stroke = '#0f172a';
      frag.appendChild(i);
      const lbl = document.createElement('div');
      lbl.style.fontSize = '12px';
      lbl.style.marginTop = '-2px';
      lbl.style.color = '#0f172a';
      lbl.textContent = tab.label;
      frag.appendChild(lbl);
      return frag;
    }

    for (let i = 0; i < tabs.length; i++) {
      const tab = tabs[i];
      let item = existing[i];
      if (item) {
        while (item.firstChild) item.removeChild(item.firstChild);
        item.appendChild(makeIconLabel(tab));
        item.classList.add('nav-item');
        item.dataset.id = tab.id;
        item.style.cssText = "text-align:center;cursor:pointer;transition:transform .2s;flex:1;";
      } else {
        item = document.createElement('div');
        item.className = 'nav-item';
        item.dataset.id = tab.id;
        item.style.cssText = "text-align:center;cursor:pointer;transition:transform .2s;flex:1;";
        item.appendChild(makeIconLabel(tab));
        nav.appendChild(item);
      }
    }

    safeInitIcons();

    // --- fixed and simplified correct navigation map ---
    const routeMap = {
      chats: "/inbox",          // main chat inbox page
      calls: "/calls",    // call page
      Updates: "/Updates",     // Updates page
      settings: "/settings"    // settings page
    };
  }

  // Elegant non-repeating gradient background
  document.documentElement.style.background = 'linear-gradient(180deg, #f8fafc 0%, #eef2ff 100%)';
  document.documentElement.style.backgroundRepeat = 'no-repeat';
  document.documentElement.style.backgroundAttachment = 'fixed';

  const currTop = parseInt(window.getComputedStyle(document.body).paddingTop || '0', 10);
  if (currTop < 90) document.body.style.paddingTop = '90px';
  const currBottom = parseInt(window.getComputedStyle(document.body).paddingBottom || '0', 10);
  if (currBottom < 130) document.body.style.paddingBottom = '130px';

})();

(function() {
  const routeMap = {
    chats: '/inbox',
    calls: '/calls',
    Updates: '/updates',
    settings: '/settings'
  };

  // Inject bounce animation style
  const style = document.createElement('style');
  style.textContent = `
    @keyframes navBounce {
      0%   { transform: scale(1); }
      30%  { transform: scale(1.25); }
      60%  { transform: scale(0.9); }
      100% { transform: scale(1); }
    }
    .nav-bounce {
      animation: navBounce 0.35s cubic-bezier(.28,1.25,.47,1.03);
    }
  `;
  document.head.appendChild(style);

  // Add click logic with bounce
  document.querySelectorAll('.bottom-nav .nav-item').forEach(item => {
    item.addEventListener('click', e => {
      e.preventDefault();
      item.classList.remove('nav-bounce');
      void item.offsetWidth; // restart animation
      item.classList.add('nav-bounce');

      const id = item.dataset.id;
      const target = routeMap[id];
      if (target && window.location.pathname !== target) {
        setTimeout(() => window.location.href = target, 250); // navigate after bounce
      }
    });
  });
})();

</script>
</body>
</html>
